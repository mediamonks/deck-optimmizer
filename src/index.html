<!DOCTYPE html>
<html>

<head>
    <title>Deck Optimmizer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;900&display=swap" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
</head>

<body>

    <div class="footer">deck optimmizer beta v0.2 <a target="_blank"
            href="https://github.com/mirkovw/deck-optimmizer">source</a></div>
    <div class="main">

        <div class="title"> deck optimmizer <sup class="beta">beta</sup> </div>
        <div class="helpTxt">
            First, share the deck with<br>
            deck-optimmizer@deck-optimmizer.iam.gserviceaccount.com<br><br>

            Then, enter the URL in the field below and hit 'Optimize'.
        </div>

        <form class='form' id="form" action="">
            <input id="input" autocomplete="off" />
            <button class="optimize">Optimize</button>
        </form>

        <ul id="messages">
        </ul>

        <form id="optimizeChoice">
            <input type="radio" name="optimizeChoice" value="auto" onclick=DisplayAuto()>
            <label for="auto">Auto-Optimize</label>
            <input type="radio" name="optimizeChoice" value="manual" onclick=DisplayManual()>
            <label for="manual">Optimize Manually</label>
        </form>

        <br>
        <div id="optimizePanel">
            <ul>
                <li>Original</li>
                <li></li>
                <li>Preview</li>
            </ul>
        </div>

        <div id="optionsContainer">
            <form id="optionsForm" action="">
                <label for="">Apply lossy compression?</label>
                <input type="checkbox" id="applyLossy" onchange="displaySlider('applyLossy', 'displayCompFactor')">
                <br>
                
                <div id="displayCompFactor">
                    <label for="factor">Compression Factor:</label>
                    <label for="factor" id="displayFactor">30</label>
                    <input type="range" min="0" max="250" value="30" step="5" class="slider" id="factor" oninput="updateSliderValue('factor', 'displayFactor')">
                </div>
                <br>
                
                <label for="">Apply colour correction?</label>
                <input type="checkbox" id="applyColourCorrect" onchange="displaySlider('applyColourCorrect', 'displayColourRange')">
                <br>
                
                <div id="displayColourRange">
                    <label for="">Colour range:</label>
                    <label for="range" id="displayRange">60</label>
                    <input type="range" min="2" max="256" value="60" step="8" class="slider" id="colourRange" oninput="updateSliderValue('colourRange', 'displayRange')">
                </div>
                <br>

                <label for="">Adjust frame rate?</label>
                <input type="checkbox" id="adjustFrameRate" onchange="displaySlider('adjustFrameRate', 'displayFrameRate')">
                <br>
                
                <div id="displayFrameRate">
                    <label for="">Frame rate:</label>
                    <label for="frameRate" id="displayframeRate">30</label>
                    <input type="range" min="5" max="100" value="30" step="5" class="slider" id="frameRate" oninput="updateSliderValue('frameRate', 'displayframeRate')">
                </div>
                <br>

                <button type="button" onclick="optimizeGif(event)">Apply</button>

            </form>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        var messages = document.getElementById('messages');
        var form = document.getElementById('form');
        var optimizeChoice = document.getElementById('optimizeChoice');
        var input = document.getElementById('input');

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            if (input.value) {
                document.querySelector('#form').remove();
                document.querySelector('.helpTxt').innerHTML = 'Would you like to run an auto optimization or choose tune each gif manually?';
                //document.querySelector('#messages').style.display='block';

                document.querySelector('#optimizeChoice').style.display = 'block';

                socket.emit('presentationId', input.value);
                input.value = '';
            }
        });

        function displayOptions(event){
                //clear on every gif clicked
                var source = document.getElementById('source');
                var dest = document.getElementById('dest');
                try{
                    source.id = "";
                    dest.id = "";
                } catch {};
                
                var gif = event.target;
                var optionsColumn = gif.parentElement.nextSibling;
                var optionsContainer = document.querySelector('#optionsContainer');
                var outputGif = optionsColumn.nextSibling.firstChild;
                
                optionsColumn.append(optionsContainer);
                optionsContainer.style.display = 'block';

                gif.id = 'source';
                outputGif.id = 'dest';
            };

        function optimizeGif(event){
            var sourceGif = document.getElementById('source');
            var destGif = document.getElementById('dest');

            var applyLossy = document.querySelector('#applyLossy').checked;
            var factor = document.getElementById('factor').value;
            var applyColourCorrect = document.querySelector('#applyColourCorrect').checked;
            var colourRange = document.getElementById('colourRange').value;
            var adjustFrameRate = document.querySelector('#adjustFrameRate').checked;
            var frameRate = document.getElementById('frameRate').value;

            socket.emit('applyOptimizeSettings', {'applyLossy':applyLossy, 'factor':factor, 'applyColourCorrect':applyColourCorrect, 'colourRange':colourRange, 'adjustFrameRate':adjustFrameRate, 'frameRate':frameRate, 'gifId':sourceGif.getAttribute('gifId'), 'src':sourceGif.src});
        }

        function displaySlider(checkboxID, target){
            var checkbox = document.getElementById(checkboxID);
            var target = document.getElementById(target);
            if (checkbox.checked == true){
                target.style.display = 'block';
            } else {
                target.style.display = 'none';
            }
        };

        function updateSliderValue(sliderId, target){
            var slider = document.getElementById(sliderId);
            var target = document.getElementById(target);
            target.innerHTML = slider.value;
        };

        // TODO: Display only 1 preview source/output gif
        function DisplayAuto() {
            document.querySelector('#optimizePanel').style.display = 'block';
            document.querySelector('#optionsContainer').style.display = 'block';
        };

        function DisplayManual() {
            document.querySelector('#optimizePanel').style.display = 'block';
            document.querySelector('#optionsContainer').style.display = 'none';
        };

        socket.on('replaceGif', async function(msg){
            document.getElementById('dest').src = (msg.output + '?random=' + new Date().getTime());
        });

        socket.on('DisplayGif', function (msg) {
            var targetArea = document.getElementById('optimizePanel');
            var ul = document.createElement('ul');
            var li = document.createElement('li');
            var gif = document.createElement('img');

            // Source gif
            ul.appendChild(li);
            gif.src = msg.source;
            gif.setAttribute('gifId', msg.id);
            gif.setAttribute('deckId', msg.deckId);
            li.appendChild(gif);

            // Options
            ul.appendChild(document.createElement('li'));

            // Output gif
            li = document.createElement('li');
            var outputGif = document.createElement('img');
            ul.appendChild(li);
            outputGif.src = msg.output;
            outputGif.setAttribute('gifId', msg.id);
            outputGif.setAttribute('deckId', msg.deckId);
            li.appendChild(outputGif);

            gif.addEventListener("click", displayOptions, false);
            targetArea.appendChild(ul);
        });

        socket.on('update message', function (msg) {
            var item = document.createElement('li');
            item.innerHTML = msg.data;
            //messages.appendChild(item);
            messages.insertBefore(item, messages.firstChild);

            //window.scrollTo(0, document.body.scrollHeight);
            console.log(msg.data)
        });
    </script>
</body>

</html>