<!DOCTYPE html>
<html>

<head>
    <title>Deck Optimmizer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;900&display=swap" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <script src="https://apis.google.com/js/platform.js?onload=init" async defer></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <meta name="google-signin-client_id" content="891852856749-q0k1uekqoku5oiqlgdps6ke07j3qe4q3.apps.googleusercontent.com">

</head>

<body>
    <div class="main">
        
        <div id="accountbar">
            <div class="g-signin2" data-onsuccess="onSignIn">    
            </div>
            <a href="#" id="signOutButton" onclick="signOut();">Sign out</a>
        </div>

        <div class="title"> deck optimmizer <sup class="beta">beta</sup> </div>

        <div id="log">
            <div id="expandarea">
                <p>Process Log</p>
                <img id="minimize" src="./minimize.png">
                <img id="maximize" src="./maximize.png">
            </div>
            <ul id="messages"></ul>
        </div>

        <div class="helpTxt">
            First, share the deck with<br>
            deck-optimmizer@deck-optimmizer.iam.gserviceaccount.com<br><br>

            Then, enter the URL in the field below and hit 'Optimize'.
        </div>

        <form class='form' id="form" action="">
            <input id="input" autocomplete="off" />
            <button class="optimize">Optimize</button>
        </form>


        <form id="optimizeChoice">
            <input type="radio" name="optimizeChoice" value="auto" id="AutoOptimize" onclick=DisplayAuto()>
            <label for="auto">Auto-Optimize</label>
            <input type="radio" name="optimizeChoice" value="manual" id="ManualOptimize" onclick=DisplayManual()>
            <label for="manual">Optimize Manually</label>
        </form>

        <br>
        <div id="optimizePanel">
            <ul id="listHeader">
                <li>Original</li>
                <li></li>
                <li>Preview</li>
            </ul>
        </div>

        <div id="optionsContainer">
            <form id="optionsForm" action="">
                <label for="">Apply lossy compression?</label>
                <input type="checkbox" id="applyLossy" onchange="displaySlider('applyLossy', 'displayCompFactor')">
                <br>
                
                <div id="displayCompFactor">
                    <label for="factor">Compression Factor:</label>
                    <label for="factor" id="displayFactor">30</label>
                    <input type="range" min="0" max="250" value="30" step="5" class="slider" id="factor" oninput="updateSliderValue('factor', 'displayFactor')">
                </div>
                <br>
                
                <label for="">Apply colour correction?</label>
                <input type="checkbox" id="applyColourCorrect" onchange="displaySlider('applyColourCorrect', 'displayColourRange')">
                <br>
                
                <div id="displayColourRange">
                    <label for="">Colour range:</label>
                    <label for="range" id="displayRange">60</label>
                    <input type="range" min="2" max="256" value="60" step="8" class="slider" id="colourRange" oninput="updateSliderValue('colourRange', 'displayRange')">
                </div>
                <br>

                <label for="">Adjust frame rate?</label>
                <input type="checkbox" id="adjustFrameRate" onchange="displaySlider('adjustFrameRate', 'displayFrameRate')">
                <br>
                
                <div id="displayFrameRate">
                    <label for="">Frame rate:</label>
                    <label for="frameRate" id="displayframeRate">30</label>
                    <input type="range" min="5" max="100" value="30" step="5" class="slider" id="frameRate" oninput="updateSliderValue('frameRate', 'displayframeRate')">
                </div>
                <br>

                <button type="button" onclick="optimizeGif(event)">Apply</button>

            </form>
        </div>

        <div id="processOptions">
            <button type="button" onclick="cancelOptimization(event)" id="cancelBtn">Cancel</button>
            <button type="button" onclick="updateDeck(event)" id="finishBtn">Finish</button>
        </div>

    </div>

    <div class="footer">deck optimmizer beta v0.2 <a target="_blank" href="https://github.com/mirkovw/deck-optimmizer">source</a></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        var input = document.getElementById('input');

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            if (input.value) {
                document.querySelector('#form').remove();
                document.querySelector('.helpTxt').innerHTML = 'Would you like to run an auto optimization or choose tune each gif manually?';

                document.querySelector('#optimizeChoice').style.display = 'block';

                socket.emit('presentationId', input.value);
                input.value = '';
            }
        });

        document.getElementById("expandarea").addEventListener("click", toggleLog);

        async function toggleLog(){
            let minimize = document.getElementById('minimize');
            let maximize = document.getElementById('maximize');
            let messages = document.getElementById('messages');

            if (minimize.style.display == "block"){
                maximize.style.display = "block";
                minimize.style.display = "none";
                messages.style.display = "none";
            } else {
                minimize.style.display = "block";
                maximize.style.display = "none";
                messages.style.display = "block";
            }
        }

        function onSignIn(googleUser) {
            var profile = googleUser.getBasicProfile();
            var id_token = googleUser.getAuthResponse().id_token;
            window.sessionStorage.setItem('google-session', id_token);
            document.getElementById("signOutButton").style.display = "block";
        }

        function signOut() {
            var auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function () {
                console.log('User signed out.');
                document.getElementById("signOutButton").style.display = "none";
            });
        }
        
        async function displayOptions(event){
                //clear on every gif clicked
                var source = document.getElementById('source');
                var dest = document.getElementById('dest');
                try{
                    source.id = "";
                    dest.id = "";
                } catch {};
                
                var gif = event.target;
                var optionsColumn = gif.parentElement.nextSibling;
                var optionsContainer = document.querySelector('#optionsContainer');
                var outputGif = optionsColumn.nextSibling.firstChild;
                
                optionsColumn.append(optionsContainer);
                optionsContainer.style.display = 'block';

                gif.id = 'source';
                outputGif.id = 'dest';
            };

        async function optimizeGif(event){
            var sourceGif = document.getElementById('source');
            var destGif = document.getElementById('dest');

            var applyLossy = document.querySelector('#applyLossy').checked;
            var factor = document.getElementById('factor').value;
            var applyColourCorrect = document.querySelector('#applyColourCorrect').checked;
            var colourRange = document.getElementById('colourRange').value;
            var adjustFrameRate = document.querySelector('#adjustFrameRate').checked;
            var frameRate = document.getElementById('frameRate').value;

            var auto = document.querySelector('#AutoOptimize').checked;
            
            if (auto){
                gifElements = document.querySelectorAll('[gifid]');
                
                let minimize = document.getElementById('minimize');
                let maximize = document.getElementById('maximize');
                let messages = document.getElementById('messages');
                optimizeArray = [];
                
                document.getElementById("optionsForm").style.display = "none";
                minimize.style.display = "block";
                maximize.style.display = "none";
                messages.style.display = "block";

                gifElements.forEach(element => {
                    sourceGif = element.getAttribute('src')  
                    gifid = element.getAttribute('gifid')
                    optimizeArray.push(new Promise(async (resolve) => {
                        socket.emit('applyOptimizeSettings', {'auto':auto, 'applyLossy':applyLossy, 'factor':factor, 'applyColourCorrect':applyColourCorrect, 'colourRange':colourRange, 'adjustFrameRate':adjustFrameRate, 'frameRate':frameRate, 'gifId':gifid, 'src':sourceGif});
                        resolve();
                    }))
                });
                await Promise.all(optimizeArray);

            } else {
                socket.emit('applyOptimizeSettings', {'auto':auto, 'applyLossy':applyLossy, 'factor':factor, 'applyColourCorrect':applyColourCorrect, 'colourRange':colourRange, 'adjustFrameRate':adjustFrameRate, 'frameRate':frameRate, 'gifId':sourceGif.getAttribute('gifId'), 'src':sourceGif.src});
            }
        };


        function displaySlider(checkboxID, target){
            // update display of slider
            var checkbox = document.getElementById(checkboxID);
            var target = document.getElementById(target);
            if (checkbox.checked == true){
                target.style.display = 'block';
            } else {
                target.style.display = 'none';
            }
        };

        function updateSliderValue(sliderId, target){
            var slider = document.getElementById(sliderId);
            var target = document.getElementById(target);
            target.innerHTML = slider.value;
        };

        function DisplayAuto() {
            parent = document.getElementById('optimizeChoice');
            container = document.querySelector('#optionsContainer')
            parent.after(container);

            document.querySelector('#optimizePanel').style.display = 'none';
            container.style.display = 'block';
            document.querySelector('#processOptions').style.display = 'block';
        };

        function DisplayManual() {
            document.querySelector('#optimizePanel').style.display = 'block';
            document.querySelector('#optionsContainer').style.display = 'none';
            document.querySelector('#processOptions').style.display = 'block';
        };

        function updateDeck(event){
            gifElements = document.querySelectorAll('[gifid]');
            deckid = gifElements[0].getAttribute('deckid');

            var gifData = {};

            gifElements.forEach(element => {
                gifData[element.getAttribute('gifid')] = element.getAttribute('src')                
            });

            let googletoken = window.sessionStorage.getItem('google-session');

            socket.emit('updateCopyDeck', {'gifData':gifData, 'deckid':deckid, 'token': googletoken});
        };

        function cancelOptimization(event){
            // delete all stored gifs & copy of slides
            gifElements = document.querySelectorAll('[gifid]');
            deckid = gifElements[0].getAttribute('deckid');

            var gifIds = [];

            gifElements.forEach(element => {
                gifIds.push(element.getAttribute('gifid'))
            });

            socket.emit('deleteGifs', {'gifIds':gifIds, 'deckid':deckid});
            location.reload();
        };

        socket.on('replaceGif', async function(msg){
            //assign timestamp to src to refresh img (does not refresh img if src is the same url) 
            document.getElementById('dest').src = (msg.output + '?random=' + new Date().getTime());
        });

        socket.on('DisplayGif', function (msg) {
            for (const [key, val] of Object.entries(msg.gifarray)){
                var targetArea = document.getElementById('optimizePanel');
                var ul = document.createElement('ul');
                var li = document.createElement('li');
                var gif = document.createElement('img');

                // Source gif
                ul.appendChild(li);
                gif.src = val['source'];
                gif.setAttribute('gifId', val['id']);
                gif.setAttribute('deckId', val['deckId']);
                li.appendChild(gif);

                // Options
                ul.appendChild(document.createElement('li'));

                // Output gif
                li = document.createElement('li');
                var outputGif = document.createElement('img');
                ul.appendChild(li);
                outputGif.src = val['output'];
                outputGif.setAttribute('gifId', val['id']);
                outputGif.setAttribute('deckId', val['deckId']);
                li.appendChild(outputGif);

                gif.addEventListener("click", displayOptions, false);
                targetArea.appendChild(ul);
            };
            //socket.emit("update message", {data: });
            var item = document.createElement('li');
            item.innerHTML = "Preview loaded.";
            messages.insertBefore(item, messages.firstChild);
        });

        socket.on('update message', function(msg) {
            var item = document.createElement('li');
            item.innerHTML = msg.data;
            //messages.appendChild(item);
            messages.insertBefore(item, messages.firstChild);
            console.log(msg.data)
    });
    </script>
</body>

</html>